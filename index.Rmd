---
title: "COVID-19"
knit: (function(input_file, encoding) {
  out_dir <- 'docs';
  rmarkdown::render(input_file,
 encoding=encoding,
 output_file=file.path(dirname(input_file), out_dir, 'index.html'))})
output:
  html_document:
    toc: true
    toc_float: TRUE
    theme: darkly
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE, message = FALSE)
library(magrittr) # %>%
library(dplyr) # rename()
library(readr) # read_csv()
library(tidyr)
library(lubridate)
library(pander)
library(ggplot2)
library(gt) #format tables
library(kableExtra)
library(gridExtra) # grid.arrange
library(tidycensus) # population data
readRenviron(".Renviron")
```

## Background and Data

COVID-19 is causing havoc in Oregon once again, and as numbers continue to spike, I decided to revisit one the of the first projects I worked on in R Studio. That project can be seen [here](https://rbolt13.github.io/rsite/covid.html), and used data from Johns Hopkins. However, because that data is no longer updated this investigation will use data from the NY times that has more current data. The repository for the NY Times data can be found [here](https://github.com/nytimes/covid-19-data), and the datasets that are being included are : 

1. **us.states** : state level data (file description [here](https://github.com/nytimes/covid-19-data/blob/master/README.md))

2. **us.counties** : county-level data (file description [here](https://github.com/nytimes/covid-19-data/blob/master/README.md))

3. **colleges** : number of reported cases among students and employees at American colleges and universities, updated May 26th (file description [here](https://github.com/nytimes/covid-19-data/tree/master/colleges))

4. **mask_use** : survey between July 2 and July 14 (2020) where participants were asked, _"How oftern do you wear a mask in public when you expect to be within six feet of another person?"_ (file description [here](https://github.com/nytimes/covid-19-data/tree/master/mask-use)) 

5. **vacc**: state level COVID-19 daily vaccination numbers time series data from the Johns Hopkins University repository (file description [here](https://github.com/govex/COVID-19/blob/master/data_tables/vaccine_data/us_data/readme.md))

6. **policytrackerOR**:  dates and description of policies going into/out of effect in Oregon.  To load data for a particular state go to [here](https://github.com/govex/COVID-19/tree/govex_data/data_tables/policy_data/table_data/Current), find the name of the state file you want to work with. 

Here is the data :

```{r load_data}
us.states <- read_csv('https://raw.githubusercontent.com/nytimes/covid-19-data/master/us-states.csv')
us.counties <- read_csv('https://raw.githubusercontent.com/nytimes/covid-19-data/master/us-counties.csv')
colleges <- read_csv('https://raw.githubusercontent.com/nytimes/covid-19-data/master/colleges/colleges.csv')
mask_use <- read_csv('https://raw.githubusercontent.com/nytimes/covid-19-data/master/colleges/colleges.csv')
vacc <- read_csv("https://raw.githubusercontent.com/govex/COVID-19/master/data_tables/vaccine_data/us_data/time_series/people_vaccinated_us_timeline.csv")
policytrackerOR <- read_csv("https://raw.githubusercontent.com/govex/COVID-19/govex_data/data_tables/policy_data/table_data/Current/Oregon_policy.csv")
```

The projected cited above mainly looked at the case, death, and vaccination numbers per state to compare highly and mildly impacted states. In this project I will look at highly impacted states and the counties of Oregon. Additionally this project will use population and density data from the tidycensus package. I discuss more about how I got this data using an API in a blog post [here](https://rbolt.netlify.app/post/2021/08/30/tidycensus-package/). Note that this data is from 2019, which is a couple years older than the COVID data. 

```{r}
state.pop <- get_estimates(geography = "state", year = 2019, variable =  "POP") %>% rename ("state" = NAME, "population" = value)
state.den <- get_estimates(geography = "state", year = 2019, variable =  "DENSITY") %>% rename ("state" = NAME, "density" = value)
or.county.pop <- get_estimates(geography = "county", state = "OR", year = 2019, variable = "POP") %>% rename ("county" = NAME, "population" = value)
or.county.den <- get_estimates(geography = "county", state = "OR", year = 2019, variable = "DENSITY") %>% rename ("county" = NAME, "density" = value)
```

# Wrangling the Data
The COVID data set is already in long form (meaning the dates are in rows instead of columns), and the date is already saved as a date variable. Therefore the main tasks here are to join the us.states data set with the vaccination records, and population estimates. Then join the us.states.vacc with the population data and create new percentage columns. 

```{r, echo=F}
# join states population with density
state.est <- state.pop %>%
  select(state, population) %>%
  full_join(state.den %>%
              select(state, density),
            by = c("state" = "state"))
# join states with vacc
us.states.vacc <- us.states %>%
  select(date, state, cases, deaths) %>%
  full_join(vacc %>%
              select(Province_State, Date, Lat, Long_,People_Fully_Vaccinated, People_Partially_Vaccinated),
            by = c("state"="Province_State", "date"="Date")) %>%
  select(date, state, cases, deaths, People_Fully_Vaccinated, People_Partially_Vaccinated) %>%
  # join with census population data
  full_join(state.est %>%
              select(state, population, density),
            by = c("state"="state")) %>%
  summarise(date = date,
            state = state,
            population = population,
            density = density,
            cases = cases,
            case.per = cases/population,
            deaths = deaths,
            perc.deaths = deaths/population,
            full.vacc = People_Fully_Vaccinated,
            full.vacc.perc = full.vacc/population,
            part.vacc = People_Partially_Vaccinated,
            part.vacc.perc = part.vacc/population)
head(us.states.vacc, n=5)
```

Note: People_Fully_Vaccinated and People_Partially_Vaccinated show as NA because of the dates displayed were before the vaccine was released.

Next, to join the Oregon county population data with the density data, remove "County, Oregon" from each county object, filter out Oregon from the us.counties data, and then join with the population data per county. 
```{r, echo=FALSE}
# join states population with density and clean
or.county.est <- or.county.pop %>%
  select(county, population) %>%
  full_join(or.county.den %>%
              select(county, density),
            by = c("county" = "county"))
# remove " County, Oregon" from the county name (this will make joining later easier)
or.county.est$county <- gsub(" County, Oregon", "", or.county.pop$county )
# select only oregon counties, and join with population
or.covid.est <- us.counties %>%
  filter(state == "Oregon") %>%
  select(date, county, cases, deaths) %>%
  full_join(or.county.est %>%
              select(county, population, density),
            by = c("county"="county"))%>% 
  summarise(date = date,
            county = county,
            population = population,
            density = density,
            cases = cases,
            cases.perc = cases/population,
            deaths = deaths,
            deaths.perc = deaths/population) 
head(or.covid.est, n=10)
```

---

# Using the data

## Looking at States

To begin lets look at the country as a whole, by state. The data will be filtered for **January 1st, 2022**, and then lets look at the top five states with :

```{r}
Date <- "2022-01-01"
```


### Most number of cases
```{r, echo=F}
us.states.cases <- us.states.vacc %>%
  filter(date == Date) %>%
  select(state, population, cases, case.per) %>%
  arrange(desc(cases)) %>%
    head(5) %>%
    gt() %>%
    fmt_number(columns = cases, decimals = 0) %>%
    fmt_number(columns = population, decimals = 0) %>%
    fmt_percent(columns = case.per, decimals = 2) %>%
    tab_header(title = md("**Most Cases**"),
               subtitle = paste0("By State as of ", Date)) %>%
    cols_label(state = md("**State**"),
               population = md("**Total Population**"),
               cases = md("**Cases**"),
               case.per = md("**Percentage**")) %>%
   tab_style(style = list(
             cell_fill(color = "lightcyan")),
   locations = cells_body(
       columns = everything()
     ))
us.states.cases
```



### Highest percentage of cases 
```{r, echo=F}
# filter - select - arrange
us.states.cases.perc <- us.states.vacc %>%
  filter(date == Date) %>%
  select(state, population, cases, case.per) %>%
  arrange(desc(case.per)) 
# table
gt(us.states.cases.perc[1:5,]) %>%
    fmt_number(columns = cases, decimals = 0) %>%
    fmt_number(columns = population, decimals = 0) %>%
    fmt_percent(columns = case.per, decimals = 2) %>%
    tab_header(title = md("**Highest Percent of Cases**"),
               subtitle = paste0("By State as of ", Date)) %>%
    cols_label(state = md("**State**"),
               population = md("**Total Population**"),
               cases = md("**Cases**"),
               case.per = md("**Percentage**")) %>%
   tab_style(style = list(
             cell_fill(color = "lightcyan")),
   locations = cells_body(
       columns = everything()
     ))
```

### Most number of deaths
```{r, echo=F}
us.states.deaths <- us.states.vacc %>%
  filter(date == Date) %>%
  select(state, population, deaths, perc.deaths) %>%
  arrange(desc(deaths))
# table
gt(us.states.deaths[1:5,]) %>%
    fmt_number(columns = deaths, decimals = 0) %>%
    fmt_number(columns = population, decimals = 0) %>%
    fmt_percent(columns = perc.deaths, decimals = 2) %>%
    tab_header(title = md("**Most Deaths**"),
               subtitle = paste0("By State as of ", Date)) %>%
    cols_label(state = md("**State**"),
               population = md("**Total Population**"),
               deaths = md("**Deaths**"),
               perc.deaths = md("**Percentage**")) %>%
   tab_style(style = list(
             cell_fill(color = "lightcyan")),
   locations = cells_body(
       columns = everything()
     ))
```

### Highest percentage of deaths 
```{r, echo=F}
us.states.deaths.perc <- us.states.vacc %>%
  filter(date == Date) %>%
  select(state, population, deaths, perc.deaths) %>%
  arrange(desc(perc.deaths)) 
# table
gt(us.states.deaths.perc[1:5,]) %>%
    fmt_number(columns = deaths, decimals = 0) %>%
    fmt_number(columns = population, decimals = 0) %>%
    fmt_percent(columns = perc.deaths, decimals = 2) %>%
    tab_header(title = md("**Highest percent of Deaths**"),
               subtitle = paste0("By State as of ", Date)) %>%
    cols_label(state = md("**State**"),
               population = md("**Total Population**"),
               deaths = md("**Deaths**"),
               perc.deaths = md("**Percentage**")) %>%
   tab_style(style = list(
             cell_fill(color = "lightcyan")),
   locations = cells_body(
       columns = everything()
     ))
```

### Most people fully vaccinated 
```{r, echo=F}
us.states.most.vacc <- us.states.vacc %>%
  filter(date == Date) %>%
  select(state, population, full.vacc, full.vacc.perc) %>%
  arrange(desc(full.vacc)) 
# Table
gt(us.states.most.vacc[1:5,]) %>%
    fmt_number(columns = full.vacc, decimals = 0) %>%
    fmt_number(columns = population, decimals = 0) %>%
    fmt_percent(columns = full.vacc.perc, decimals = 2) %>%
    tab_header(title = md("**Most People Vaccinated**"),
               subtitle = paste0("By State as of ", Date)) %>%
    cols_label(state = md("**State**"),
               population = md("**Total Population**"),
               full.vacc = md("**People Fully Vaccinated**"),
               full.vacc.perc = md("**Percentage**")) %>%
   tab_style(style = list(
             cell_fill(color = "lightcyan")),
   locations = cells_body(
       columns = everything()
     ))
```

### Highest percentage of population fully vaccinated 
```{r, echo=F}
us.states.vacc.perc <- us.states.vacc %>%
  filter(date == Date) %>%
  select(state, population, full.vacc, full.vacc.perc) %>%
  arrange(desc(full.vacc.perc))
# table
gt(us.states.vacc.perc[1:5,]) %>%
    fmt_number(columns = full.vacc, decimals = 0) %>%
    fmt_number(columns = population, decimals = 0) %>%
    fmt_percent(columns = full.vacc.perc, decimals = 2) %>%
    tab_header(title = md("**Highest Percent of People Fully Vaccinated**"),
               subtitle = paste0("By State as of ", Date)) %>%
    cols_label(state = md("**State**"),
               population = md("**Total Population**"),
               full.vacc = md("**People Fully Vaccinated**"),
               full.vacc.perc = md("**Percentage**")) %>%
   tab_style(style = list(
             cell_fill(color = "lightcyan")),
   locations = cells_body(
       columns = everything()
     ))
```

### Overview

This is were I point out some things I notice.

## Looking at Oregon Counties

Next to look at the data a little closer to home, for Oregon Counties. Initially filtering by the most recent date, which as of this being written is **December 21st, 2021**, and then look at the top five Oregon counties.

### Most number of cases
```{r, echo = F}
# cases
or.county.cases <- or.covid.est %>%
  filter(date == Date) %>%
  select(county, population, cases, cases.perc) %>%
  arrange(desc(cases)) %>%
    head(5) %>%
    gt() %>%
    fmt_number(columns = cases, decimals = 0) %>%
    fmt_number(columns = population, decimals = 0) %>%
    fmt_percent(columns = cases.perc, decimals = 2) %>%
    tab_header(title = md("**Most Cases**"),
               subtitle = paste0("Oregon Counties as of ", Date)) %>%
    cols_label(county = md("**County**"),
               population = md("**Total Population**"),
               cases = md("**Cases**"),
               cases.perc = md("**Percentage**")) %>%
   tab_style(style = list(
             cell_fill(color = "#F9E3D6")),
   locations = cells_body(
       columns = everything()
     ))
or.county.cases
```


### Highest percentage of Cases 
```{r, echo = F}
#cases percent
or.county.cases.perc <- or.covid.est %>%
  filter(date == Date) %>%
  select(county, population, cases, cases.perc) %>%
  arrange(desc(cases.perc)) %>%
    head(5) %>%
    gt() %>%
    fmt_number(columns = cases, decimals = 0) %>%
    fmt_number(columns = population, decimals = 0) %>%
    fmt_percent(columns = cases.perc, decimals = 2) %>%
    tab_header(title = md("**Highest Percentage of Cases**"),
               subtitle = paste0("Oregon Counties as of ", Date)) %>%
    cols_label(county = md("**County**"),
               population = md("**Total Population**"),
               cases = md("**Cases**"),
               cases.perc = md("**Percentage**")) %>%
   tab_style(style = list(
             cell_fill(color = "#F9E3D6")),
   locations = cells_body(
       columns = everything()
     ))
or.county.cases.perc
```


### Most number of Deaths
```{r, echo = F}
#deaths
or.county.deaths <- or.covid.est %>%
  filter(date == Date) %>%
  select(county, population, deaths, deaths.perc) %>%
  arrange(desc(deaths)) %>%
    head(5) %>%
    gt() %>%
    fmt_number(columns = deaths, decimals = 0) %>%
    fmt_number(columns = population, decimals = 0) %>%
    fmt_percent(columns = deaths.perc, decimals = 2) %>%
    tab_header(title = md("**Most Deaths**"),
               subtitle = paste0("Oregon Counties as of ", Date)) %>%
    cols_label(county = md("**County**"),
               population = md("**Total Population**"),
               deaths = md("**Deaths**"),
               deaths.perc = md("**Percentage**")) %>%
   tab_style(style = list(
             cell_fill(color = "#F9E3D6")),
   locations = cells_body(
       columns = everything()
     ))
or.county.deaths
```

### Highest percentage of Deaths
```{r, echo = F}
#deaths percentage
or.county.deaths.perc <- or.covid.est %>%
  filter(date == Date) %>%
  select(county, population, deaths, deaths.perc) %>%
  arrange(desc(deaths.perc)) %>%
    head(5) %>%
    gt() %>%
    fmt_number(columns = deaths, decimals = 0) %>%
    fmt_number(columns = population, decimals = 0) %>%
    fmt_percent(columns = deaths.perc, decimals = 2) %>%
    tab_header(title = md("**Highest Percent of Deaths**"),
               subtitle = paste0("Oregon Counties as of ", Date)) %>%
    cols_label(county = md("**County**"),
               population = md("**Total Population**"),
               deaths = md("**Deaths**"),
               deaths.perc = md("**Percentage**")) %>%
   tab_style(
     style = list(
       cell_fill(color = "#F9E3D6")
       ),
     locations = cells_body(
       columns = everything()
     ))
or.county.deaths.perc
```

### Overview 

Here I will put in an overview of what the data says. 
